# Agentic Trust

A small but opinionated demo that shows how to combine:

- **Node.js / Express** as backend
- **Couchbase** as mission store
- **HashiCorp Vault** for:
  - Transit encryption of mission bodies
  - KV for AI provider configuration
  - (optional) database credentials
- **Ollama** as the main LLM provider for Q&A
- **Hugging Face** (optional) for automatic mission summarisation
- **Nuxt 3** frontend for missions and agentic Q&A

The goal is simple:

> Take a sensitive “mission brief”, encrypt it at rest, enrich it with AI, and still keep the trust boundary very explicit.

This repository is a working lab, not a product. It is ideal for workshops, brown bags, or as a reference implementation of “agentic AI with real security controls”.

---

## High level architecture

- **Frontend**  
  - Nuxt 3 app under `./frontend`  
  - Mission dashboard, mission detail, and an agentic Q&A panel  
  - Talks to the backend over HTTP only, no direct DB or Vault access

- **Backend**  
  - Node.js / Express app (`app.js`)  
  - Routes:
    - `routes/missions.js` for mission CRUD and summary enrichment
    - `routes/ai.js` for mission scoped Q&A via Ollama
    - `routes/audit.js` for basic health and audit style checks
  - Uses:
    - `services/db/couchbaseClient.js` for Couchbase access
    - `services/vault/transit.js` + `vaultClient.js` for Vault integration
    - `services/ai/aiClient.js` as the abstraction over AI providers
    - `services/ai/providers/ollamaProvider.js` as primary LLM
    - `services/ai/providers/summaryProvider.js` for Hugging Face summaries

- **Security and trust**  
  - Mission body is **never stored in plaintext** in Couchbase  
  - Backend uses **Vault Transit** to encrypt and decrypt  
  - AI provider credentials and model configuration live in Vault KV under `kv/ai/...`  
  - Ollama and Hugging Face calls are initiated only from backend

---

## Folder layout

```text
.
├── app.js                     # Express application entrypoint
├── package.json               # Backend dependencies
├── openapi.json               # API description (used by Swagger)
├── configurations/
│   ├── logger.js              # Winston style logger
│   ├── morganLogger.js        # HTTP request logging
│   ├── swaggerOptions.js      # Swagger UI configuration
│   └── swagger-custom.css     # Swagger UI styling
├── routes/
│   ├── ai.js                  # Mission Q&A via Ollama
│   ├── audit.js               # Health and audit endpoints
│   └── missions.js            # Mission CRUD and summary enrichment
├── services/
│   ├── agent/
│   │   └── missionAgent.js    # Orchestrates mission scoped Q&A
│   ├── ai/
│   │   ├── aiClient.js        # Provider selector (Ollama, Hugging Face)
│   │   └── providers/
│   │       ├── ollamaProvider.js
│   │       ├── huggingFaceProvider.js    # Optional chat provider
│   │       └── summaryProvider.js        # Summaries via Hugging Face
│   ├── db/
│   │   └── couchbaseClient.js  # Cluster, bucket, scope and collection access
│   └── vault/
│       ├── vaultClient.js      # Base Vault client wrapper
│       ├── transit.js          # Encrypt / decrypt via Vault Transit
│       └── dbCreds.js          # Optional dynamic or static DB creds
├── scripts/
│   ├── seed_missions.sh        # Seed demo missions into Couchbase
│   ├── mission_questions.md    # Example questions for the agent
│   ├── connection_test.sh      # Quick connectivity check
│   ├── release.sh              # Simple release helper
│   └── relocate_frontend.sh    # Safely move a frontend into ./frontend
├── policies/
│   └── app-policy.hcl          # Example Vault policy for the app
└── frontend/                   # Nuxt 3 app (separate package.json)
    ├── app/                    # Nuxt app, pages, components
    ├── composables/            # useMissions, useApi, etc
    ├── layouts/
    ├── public/
    ├── nuxt.config.ts
    └── package.json
```

⸻

What the app actually does

Missions

A mission is stored in Couchbase with the following shape:

```text
{
  "id": "uuid",
  "title": "Create a brag document",
  "owner": "Ray",
  "tags": ["documentation", "brag"],
  "created_at": "2025-12-11T08:23:44.129Z",
  "encrypted_body": "vault:v1:...",
  "summary": "Short human readable synopsis generated by Hugging Face",
  "summary_status": "complete"     // or "error" or "n/a"
}
```

When the frontend creates a mission:
	1.	It sends title, body, optional owner, and tags to the backend.
	2.	The backend:
	•	Calls generateMissionSummary(body) via Hugging Face (optional enrichment)
	•	Encrypts body using Vault Transit
	•	Stores everything in Couchbase
	3.	The frontend shows:
	•	Title
	•	Summary (or “No summary stored for this mission yet.”)
	•	Status indicator based on summary_status

Agentic Q&A

When you select a mission and ask a question from the Nuxt page:
	1.	The backend fetches the mission from Couchbase.
	2.	It decrypts the encrypted_body via Vault Transit.
	3.	It builds a prompt with:
	•	The decrypted mission body
	•	The stored summary if present
	•	The user question
	4.	It sends that to Ollama via ollamaProvider.js.
	5.	The answer is streamed back to the frontend and shown in the chat view.

All of this happens without the frontend ever seeing the raw mission body through a direct DB connection.

⸻

Prerequisites

You will need:
	•	Node.js 20 or later
	•	npm or pnpm
	•	Couchbase Server (local or remote)
	•	Bucket, scope and collection for missions
	•	HashiCorp Vault
	•	Transit secrets engine enabled
	•	KV secrets engine enabled for kv/ai and optionally for DB creds
	•	Ollama running locally, or reachable via HTTP
	•	Optional: a Hugging Face account and API token for summarisation

⸻

Configuration

Backend configuration is a mix of .env and Vault KV.

Environment variables (backend)

Typical values in .env at repo root:

# Couchbase
CB_ENDPOINT=couchbase://127.0.0.1
CB_USERNAME=agentic_trust
CB_PASSWORD=super-secret
CB_BUCKET=missions
CB_SCOPE=_default
CB_COLLECTION=_default

# Vault
VAULT_ADDR=http://127.0.0.1:8200
VAULT_TOKEN=...               # For local dev only, prefer AppRole in real setups
VAULT_TRANSIT_MOUNT=transit   # Optional override
VAULT_TRANSIT_KEY=missions    # Key name used to encrypt mission bodies

# Ollama
OLLAMA_API_URL=http://127.0.0.1:11434
OLLAMA_MODEL=llama3.1         # Example

# AI provider selector
AI_PROVIDER=ollama            # huggingface is supported but typically disabled

# Logging
LOG_LEVEL=info

Vault KV for AI configuration

Hugging Face settings are read from kv/ai/huggingface for both:
	•	huggingFaceProvider.js (chat provider, usually disabled)
	•	summaryProvider.js (summaries)

Example secret:

{
  "api_key": "hf_...",
  "model": "facebook/bart-large-cnn",
  "summary_model": "facebook/bart-large-cnn"
}

You can adapt this to match the model and endpoint you actually use.

⸻

Running the backend

From the repo root:

npm install
npm run dev   # or npm start depending on your script configuration

The Express app:
	•	Loads configuration
	•	Connects to Couchbase
	•	Connects to Vault
	•	Exposes routes defined in routes/

Swagger UI is enabled through swaggerOptions.js and openapi.json. You can mount it in app.js if not already done, usually under a path such as /docs.

⸻

Running the frontend

Change into the frontend folder:

cd frontend
npm install
npm run dev

The Nuxt 3 app will:
	•	Call the backend for missions and Q&A
	•	Render:
	•	A mission list with summaries
	•	A mission detail view with status and created timestamp
	•	An agentic Q&A chat pane scoped to the selected mission

Update the base URL or API client in frontend/composables/useApiClient.ts or equivalent so it points at your backend.

⸻

Seeding data

You can seed some example missions into Couchbase using:

./scripts/seed_missions.sh

The script will:
	•	Read scripts/missions_seed.json
	•	Insert demo missions into the configured bucket/scope/collection
	•	You can then reload missions from the frontend

There is also a scripts/mission_questions.md with inspiration for Q&A prompts.

⸻

Moving or replacing the frontend

The repository includes a helper script:

./scripts/relocate_frontend.sh <source_dir> <destination_dir>

For example:

./scripts/relocate_frontend.sh ../agentic_trust_frontend ./frontend

The script:
	•	Verifies rsync and package.json availability
	•	Refuses to run if a dev server is still using the source directory
	•	Uses rsync to sync everything except node_modules, .nuxt, .output, .git
	•	Performs light verification in the destination and prints a small tree

You normally do not need this day to day, but it is handy when you want to drop in a new Nuxt template as the frontend.

⸻

Security notes

This project is opinionated about trust boundaries.
	•	Missions are encrypted using Vault Transit before writing to Couchbase.
	•	Vault is the single source of truth for:
	•	Transit keys
	•	AI provider credentials
	•	Optional database credentials
	•	The frontend has no direct database access.
	•	AI providers are configured centrally and abstracted behind services/ai/aiClient.js.
	•	Hugging Face is treated as an optional enrichment step, not a primary dependency.

For a real deployment you would:
	•	Replace direct VAULT_TOKEN usage with AppRole or JWT
	•	Use TLS everywhere
	•	Use Vault namespaces and more granular policies
	•	Rotate keys and tokens on a schedule

⸻

License and contributions

This repository is intended as a demo and workshop asset.
Feel free to fork it, adapt it, and extend it for your own labs or talks.

If you add a feature that clearly improves the “agentic trust” story
for Vault, Couchbase, or Ollama, consider contributing it back as a pull request.
